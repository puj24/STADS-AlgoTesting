#include <stdio.h>
#include <math.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>
#include <time.h>


//UISs
#include "UIS_1.h"
#include "UIS_2.h" 
#include "UIS_3.h" 
#include "UIS_4.h" 
#include "UIS_5.h" 
#include "UIS_6.h" 
#include "UIS_7.h" 
#include "UIS_8.h" 
#include "UIS_9.h" 
#include "UIS_10.h"
#include "UIS_11.h"
#include "UIS_12.h"
#include "UIS_13.h"
#include "UIS_14.h"
#include "UIS_15.h"
#include "UIS_16.h"
#include "UIS_17.h"
#include "UIS_18.h"
#include "UIS_19.h"
#include "UIS_20.h"
#include "UIS_21.h"
#include "UIS_22.h"
#include "UIS_23.h"
#include "UIS_24.h"
#include "UIS_25.h"
#include "UIS_26.h"
#include "UIS_27.h"
#include "UIS_28.h"
#include "UIS_29.h"
#include "UIS_30.h"
#include "UIS_31.h"
#include "UIS_32.h"
#include "UIS_33.h"
#include "UIS_34.h"
#include "UIS_35.h"
#include "UIS_36.h"
#include "UIS_37.h"
#include "UIS_38.h"
#include "UIS_39.h"
#include "UIS_40.h"
#include "UIS_41.h"
#include "UIS_42.h"
#include "UIS_43.h"
#include "UIS_44.h"
#include "UIS_45.h"
#include "UIS_46.h"
#include "UIS_47.h"
#include "UIS_48.h"
#include "UIS_49.h"
#include "UIS_50.h"
#include "UIS_51.h"
#include "UIS_52.h"
#include "UIS_53.h"
#include "UIS_54.h"
#include "UIS_55.h"
#include "UIS_56.h"
#include "UIS_57.h"
#include "UIS_58.h"
#include "UIS_59.h"
#include "UIS_60.h"
#include "UIS_61.h"
#include "UIS_62.h"
#include "UIS_63.h"
#include "UIS_64.h"
#include "UIS_65.h"
#include "UIS_66.h"
#include "UIS_67.h"
#include "UIS_68.h"
#include "UIS_69.h"
#include "UIS_70.h"
#include "UIS_71.h"
#include "UIS_72.h"
#include "UIS_73.h"
#include "UIS_74.h"
#include "UIS_75.h"
#include "UIS_76.h"
#include "UIS_77.h"
#include "UIS_78.h"
#include "UIS_79.h"
#include "UIS_80.h"
#include "UIS_81.h"
#include "UIS_82.h"
#include "UIS_83.h"
#include "UIS_84.h"
#include "UIS_85.h"
#include "UIS_86.h"
#include "UIS_87.h"
#include "UIS_88.h"
#include "UIS_89.h"
#include "UIS_90.h"
#include "UIS_91.h"
#include "UIS_92.h"
#include "UIS_93.h"
#include "UIS_94.h"
#include "UIS_95.h"
#include "UIS_96.h"
#include "UIS_97.h"
#include "UIS_98.h"
#include "UIS_99.h"
#include "UIS_100.h"

#include "functions_UIS.h"
#include "constants.h"

void UIS_N_i(int tot_stars_UIS[100])
{
    tot_stars_UIS[0] = N_i_1;
    tot_stars_UIS[1] = N_i_2;
    tot_stars_UIS[2] = N_i_3;
    tot_stars_UIS[3] = N_i_4;
    tot_stars_UIS[4] = N_i_5;
    tot_stars_UIS[5] = N_i_6;
    tot_stars_UIS[6] = N_i_7;
    tot_stars_UIS[7] = N_i_8;
    tot_stars_UIS[8] = N_i_9;
    tot_stars_UIS[9] = N_i_10;
    tot_stars_UIS[10] = N_i_11;
    tot_stars_UIS[11] = N_i_12;
    tot_stars_UIS[12] = N_i_13;
    tot_stars_UIS[13] = N_i_14;
    tot_stars_UIS[14] = N_i_15;
    tot_stars_UIS[15] = N_i_16;
    tot_stars_UIS[16] = N_i_17;
    tot_stars_UIS[17] = N_i_18;
    tot_stars_UIS[18] = N_i_19;
    tot_stars_UIS[19] = N_i_20;
    tot_stars_UIS[20] = N_i_21;
    tot_stars_UIS[21] = N_i_22;
    tot_stars_UIS[22] = N_i_23;
    tot_stars_UIS[23] = N_i_24;
    tot_stars_UIS[24] = N_i_25;
    tot_stars_UIS[25] = N_i_26;
    tot_stars_UIS[26] = N_i_27;
    tot_stars_UIS[27] = N_i_28;
    tot_stars_UIS[28] = N_i_29;
    tot_stars_UIS[29] = N_i_30;
    tot_stars_UIS[30] = N_i_31;
    tot_stars_UIS[31] = N_i_32;
    tot_stars_UIS[32] = N_i_33;
    tot_stars_UIS[33] = N_i_34;
    tot_stars_UIS[34] = N_i_35;
    tot_stars_UIS[35] = N_i_36;
    tot_stars_UIS[36] = N_i_37;
    tot_stars_UIS[37] = N_i_38;
    tot_stars_UIS[38] = N_i_39;
    tot_stars_UIS[39] = N_i_40;
    tot_stars_UIS[40] = N_i_41;
    tot_stars_UIS[41] = N_i_42;
    tot_stars_UIS[42] = N_i_43;
    tot_stars_UIS[43] = N_i_44;
    tot_stars_UIS[44] = N_i_45;
    tot_stars_UIS[45] = N_i_46;
    tot_stars_UIS[46] = N_i_47;
    tot_stars_UIS[47] = N_i_48;
    tot_stars_UIS[48] = N_i_49;
    tot_stars_UIS[49] = N_i_50;
    tot_stars_UIS[50] = N_i_51;
    tot_stars_UIS[51] = N_i_52;
    tot_stars_UIS[52] = N_i_53;
    tot_stars_UIS[53] = N_i_54;
    tot_stars_UIS[54] = N_i_55;
    tot_stars_UIS[55] = N_i_56;
    tot_stars_UIS[56] = N_i_57;
    tot_stars_UIS[57] = N_i_58;
    tot_stars_UIS[58] = N_i_59;
    tot_stars_UIS[59] = N_i_60;
    tot_stars_UIS[60] = N_i_61;
    tot_stars_UIS[61] = N_i_62;
    tot_stars_UIS[62] = N_i_63;
    tot_stars_UIS[63] = N_i_64;
    tot_stars_UIS[64] = N_i_65;
    tot_stars_UIS[65] = N_i_66;
    tot_stars_UIS[66] = N_i_67;
    tot_stars_UIS[67] = N_i_68;
    tot_stars_UIS[68] = N_i_69;
    tot_stars_UIS[69] = N_i_70;
    tot_stars_UIS[70] = N_i_71;
    tot_stars_UIS[71] = N_i_72;
    tot_stars_UIS[72] = N_i_73;
    tot_stars_UIS[73] = N_i_74;
    tot_stars_UIS[74] = N_i_75;
    tot_stars_UIS[75] = N_i_76;
    tot_stars_UIS[76] = N_i_77;
    tot_stars_UIS[77] = N_i_78;
    tot_stars_UIS[78] = N_i_79;
    tot_stars_UIS[79] = N_i_80;
    tot_stars_UIS[80] = N_i_81;
    tot_stars_UIS[81] = N_i_82;
    tot_stars_UIS[82] = N_i_83;
    tot_stars_UIS[83] = N_i_84;
    tot_stars_UIS[84] = N_i_85;
    tot_stars_UIS[85] = N_i_86;
    tot_stars_UIS[86] = N_i_87;
    tot_stars_UIS[87] = N_i_88;
    tot_stars_UIS[88] = N_i_89;
    tot_stars_UIS[89] = N_i_90;
    tot_stars_UIS[90] = N_i_91;
    tot_stars_UIS[91] = N_i_92;
    tot_stars_UIS[92] = N_i_93;
    tot_stars_UIS[93] = N_i_94;
    tot_stars_UIS[94] = N_i_95;
    tot_stars_UIS[95] = N_i_96;
    tot_stars_UIS[96] = N_i_97;
    tot_stars_UIS[97] = N_i_98;
    tot_stars_UIS[98] = N_i_99;
    tot_stars_UIS[99] = N_i_100;

}

double (*UIS_frames[100]) [3] = 
{arr_out_UIS_1, arr_out_UIS_2, arr_out_UIS_3, arr_out_UIS_4, arr_out_UIS_5, arr_out_UIS_6, arr_out_UIS_7, arr_out_UIS_8, arr_out_UIS_9, arr_out_UIS_10,
 arr_out_UIS_11, arr_out_UIS_12, arr_out_UIS_13, arr_out_UIS_14, arr_out_UIS_15, arr_out_UIS_16, arr_out_UIS_17, arr_out_UIS_18, arr_out_UIS_19,arr_out_UIS_20,
 arr_out_UIS_21, arr_out_UIS_22, arr_out_UIS_23, arr_out_UIS_24, arr_out_UIS_25, arr_out_UIS_26, arr_out_UIS_27, arr_out_UIS_28, arr_out_UIS_29, arr_out_UIS_30,
 arr_out_UIS_31, arr_out_UIS_32, arr_out_UIS_33, arr_out_UIS_34, arr_out_UIS_35, arr_out_UIS_36, arr_out_UIS_37, arr_out_UIS_38, arr_out_UIS_39, arr_out_UIS_40,
 arr_out_UIS_41, arr_out_UIS_42, arr_out_UIS_43, arr_out_UIS_44, arr_out_UIS_45, arr_out_UIS_46, arr_out_UIS_47, arr_out_UIS_48, arr_out_UIS_49, arr_out_UIS_50, 
 arr_out_UIS_51, arr_out_UIS_52, arr_out_UIS_53, arr_out_UIS_54, arr_out_UIS_55, arr_out_UIS_56, arr_out_UIS_57, arr_out_UIS_58, arr_out_UIS_59, arr_out_UIS_60,
 arr_out_UIS_61, arr_out_UIS_62, arr_out_UIS_63, arr_out_UIS_64, arr_out_UIS_65, arr_out_UIS_66, arr_out_UIS_67, arr_out_UIS_68, arr_out_UIS_69, arr_out_UIS_70,
 arr_out_UIS_71, arr_out_UIS_72, arr_out_UIS_73, arr_out_UIS_74, arr_out_UIS_75, arr_out_UIS_76, arr_out_UIS_77, arr_out_UIS_78, arr_out_UIS_79, arr_out_UIS_80, 
 arr_out_UIS_81, arr_out_UIS_82, arr_out_UIS_83, arr_out_UIS_84, arr_out_UIS_85, arr_out_UIS_86, arr_out_UIS_87, arr_out_UIS_88, arr_out_UIS_89, arr_out_UIS_90, 
 arr_out_UIS_91, arr_out_UIS_92, arr_out_UIS_93, arr_out_UIS_94, arr_out_UIS_95, arr_out_UIS_96, arr_out_UIS_97, arr_out_UIS_98, arr_out_UIS_99, arr_out_UIS_100,};


int sm_K_vec_arr[224792][3];
double prev_centroids_st[MAX_STARS][3]; 

int main()
{
    clock_t start, end;
    start = clock();
    
    int UIS_tot_stars[100];
    UIS_N_i(UIS_tot_stars);

    int frame = 1;
    bool TM_on = false;

    // prev frame 
    int prev_frame = frame - 1;
    int prev_tot_stars = UIS_tot_stars[prev_frame];
    double (*prev_centroids_st) [3] = UIS_frames[prev_frame];

    int prev_matched_stars = 0;
    int prev_input_ids[MAX_STARS] = {0};
    int prev_star_ids[MAX_STARS] = {0};
    double prev_data[3][MAX_STARS];

    // current frame
    int curr_frame = frame;
    int curr_tot_stars = UIS_tot_stars[curr_frame];
    double (*curr_centroids_st) [3] = UIS_frames[curr_frame];

    int curr_matched_stars = 0;
    int curr_input_ids[MAX_STARS] = {0};
    int curr_star_ids[MAX_STARS] = {0};
    double curr_data[3][MAX_STARS];

    //select next frame
    int next_frame = frame - 1;
    int next_tot_stars = UIS_tot_stars[next_frame];
    //**************************************

    int next_matched_stars = 0;
    int next_input_ids[MAX_STARS] = {0};
    int next_star_ids[MAX_STARS] = {0};
    double next_data[3][MAX_STARS];

    int RBM_matched_stars ;

    while(frame < 100)
    {
        if (frame == 1)
        {
            //LISM on previous frame
            // printf("Frame1: calling LISM\n\n");
            printf("UIS_iter_%d\n\n", prev_frame + 1);

            LISM(UIS_frames[prev_frame], prev_tot_stars, prev_data, prev_input_ids, prev_star_ids, &prev_matched_stars);
  
            printf("Total Matched Stars = %d\n", prev_matched_stars);

            if(prev_matched_stars != 0)
            {
                for (int j = 0; j < prev_matched_stars; j++)
                {
                    printf("%d %d ", prev_input_ids[j], prev_star_ids[j]);
                    printf("%.16f %.16f %.16f ", prev_data[0][j], prev_data[1][j], prev_data[2][j]);
                    printf("%.16f %.16f %.16f\n",prev_data[0][j + prev_matched_stars], prev_data[1][j + prev_matched_stars], prev_data[2][j + prev_matched_stars]);
                }
            }
            printf("\n\n\n");    
            
            //LISM on current frame
            // printf("Frame2: calling LISM\n\n");
            printf("UIS_iter_%d\n\n", curr_frame + 1);

            LISM(UIS_frames[curr_frame], curr_tot_stars, curr_data, curr_input_ids, curr_star_ids, &curr_matched_stars);
            
            printf("Total Matched Stars = %d\n", curr_matched_stars);

            if(curr_matched_stars != 0)
            {
                for (int j = 0; j < curr_matched_stars; j++)
                {
                    printf("%d %d ", curr_input_ids[j], curr_star_ids[j]);
                    printf("%.16f %.16f %.16f ", curr_data[0][j], curr_data[1][j], curr_data[2][j]);
                    printf("%.16f %.16f %.16f\n",curr_data[0][j + curr_matched_stars], curr_data[1][j + curr_matched_stars], curr_data[2][j + curr_matched_stars]);
                }
            }
            printf("\n\n\n"); 
        }
        else
        {
            if (TM_on)
            {
                // printf("Frame%d: TM succees\n\n", frame + 1);

                //curr_frame -> prev_frame
                prev_tot_stars = curr_tot_stars;
                prev_matched_stars = curr_matched_stars;

                for (int i = 0; i < MAX_STARS; i++)
                {
                    //here both fe_id, star_id are of same ith star becz these are assigned in LISM
                    prev_input_ids[i] = curr_input_ids[i];
                    prev_star_ids[i] = curr_star_ids[i];

                    //***********prev_centroid_st & curr_centroid_st***********
                    prev_frame = curr_frame;
                
                    //curr_data -> prev_data
                    prev_data[0][i] = curr_data[0][i];
                    prev_data[1][i] = curr_data[1][i];
                    prev_data[2][i] = curr_data[2][i];
                }

                //next_frame -> curr_frame
                curr_tot_stars = next_tot_stars;
                curr_matched_stars = next_matched_stars;

                double x, y, f, norm;

                for (int i = 0; i < MAX_STARS; i++)
                {
                    curr_input_ids[i] = next_input_ids[i];
                    curr_star_ids[i] = next_star_ids[i];

                    //************curr_centroid_st & next_centroid_st**********
                    curr_frame = next_frame;

                    //next_data -> curr_data
                    curr_data[0][i] = next_data[0][i];
                    curr_data[1][i] = next_data[1][i];
                    curr_data[2][i] = next_data[2][i];
                }

                for (int i = 0; i < MAX_STARS; i++)
                {
                    for (int j = 0; j < UIS_tot_stars[curr_frame]; j++)
                    {
                        if (curr_input_ids[i] == UIS_frames[curr_frame][j][0])
                        {
                            f = FOCAL_LENGTH;
                            x = UIS_frames[curr_frame][j][1] / f;
                            y = UIS_frames[curr_frame][j][2] / f;
                            
                            norm = sqrt(x*x + y*y + 1);

                            curr_data[0][i + curr_matched_stars] = x/ (norm *f);
                            curr_data[1][i + curr_matched_stars] = y/ (norm *f);
                            curr_data[2][i + curr_matched_stars] = 1/norm;
                        }
                    }
                }

                printf("UIS_iter_%d\n\n", curr_frame + 1);
                printf("Total Matched Stars = %d\n", curr_matched_stars);
                
                if(curr_matched_stars != 0)
                {
                    for (int j = 0; j < curr_matched_stars; j++)
                    {
                        printf("%d %d ", curr_input_ids[j], curr_star_ids[j]);
                        printf("%.16f %.16f %.16f ", curr_data[0][j], curr_data[1][j], curr_data[2][j]);
                        printf("%.16f %.16f %.16f\n",curr_data[0][j + curr_matched_stars], curr_data[1][j + curr_matched_stars], curr_data[2][j + curr_matched_stars]);
                    }
                }
                printf("\n\n\n");                 
            }
            else
            {
                //run LISM on next 2 frames & send them to find common stars
                prev_tot_stars = next_tot_stars;
                prev_matched_stars = 0;

                //*********** next_centroid_st -> prev_centroid_st ************
                prev_frame = next_frame;
                if (frame == 99) break;

                //LISM on frame
                // printf("Frame%d: TM Failed. Calling LISM\n\n", frame + 1);
                printf("UIS_iter_%d\n\n", prev_frame + 1);

                LISM(UIS_frames[prev_frame], prev_tot_stars, prev_data, prev_input_ids, prev_star_ids, &prev_matched_stars);
                
                if(prev_matched_stars != 0)
                {    
                    printf("Total Matched Stars = %d\n", prev_matched_stars);
                    for (int j = 0; j < prev_matched_stars; j++)
                    {
                        printf("%d %d ", prev_input_ids[j], prev_star_ids[j]);
                        printf("%.16f %.16f %.16f ", prev_data[0][j], prev_data[1][j], prev_data[2][j]);
                        printf("%.16f %.16f %.16f\n",prev_data[0][j + prev_matched_stars], prev_data[1][j + prev_matched_stars], prev_data[2][j + prev_matched_stars]);
                    }
                }
                printf("\n\n\n");  

                frame ++;
                curr_frame = frame;
                curr_tot_stars = UIS_tot_stars[curr_frame];
                curr_matched_stars = 0;
                // (*curr_centroids_st) [3] = UIS_frames[curr_frame];

                //LISM on current frame
                // printf("Frame%d: TM Failed. Calling LISM\n\n", frame + 1);
                printf("UIS_iter_%d\n\n", curr_frame + 1);

                LISM(UIS_frames[curr_frame], curr_tot_stars, curr_data, curr_input_ids, curr_star_ids, &curr_matched_stars);

                if(curr_matched_stars != 0)
                {
                    printf("Total Matched Stars = %d\n", curr_matched_stars);
                    for (int j = 0; j < curr_matched_stars; j++)
                    {
                        printf("%d %d ", curr_input_ids[j], curr_star_ids[j]);
                        printf("%.16f %.16f %.16f ", curr_data[0][j], curr_data[1][j], curr_data[2][j]);
                        printf("%.16f %.16f %.16f\n",curr_data[0][j + curr_matched_stars], curr_data[1][j + curr_matched_stars], curr_data[2][j + curr_matched_stars]);
                    }
                } 
                printf("\n\n\n");                
            }
        }

        if (frame == 99) break;
        int common_stars = 0;
        double common_centroid_data[MAX_STARS][5];

        commonStars(&common_stars, prev_matched_stars, curr_matched_stars, prev_star_ids, prev_input_ids, curr_star_ids, curr_input_ids, prev_tot_stars, curr_tot_stars, UIS_frames[prev_frame], UIS_frames[curr_frame], common_centroid_data);
        // printf("Common Stars: %d\n", common_stars);

        next_frame = frame + 1;
        frame ++;
        next_tot_stars = UIS_tot_stars[next_frame];

        if(common_stars >= 2)
        {
            double predicted_centroids_st[common_stars][3];
            predictCentroid(common_centroid_data, predicted_centroids_st, common_stars);

            double RBM_centroid_st[MAX_STARS][4];
            RBM_matched_stars = radiusBasedMatching(common_stars, next_tot_stars, predicted_centroids_st, UIS_frames[next_frame], RBM_centroid_st);
            // printf("Matched stars = %d ", RBM_matched_stars);

            //next fe, star IDs of matched stars
            for (int i = 0; i < RBM_matched_stars; i++)
            {
                next_input_ids[i] = RBM_centroid_st[i][0];
                next_star_ids[i] = RBM_centroid_st[i][1];
            }

            if(RBM_matched_stars >= N_TH_TRACKING)
            {
                //next data from sm_GC
                for (int i = 0; i < MAX_STARS; i++)
                {
                    next_data[0][i] = sm_GC[next_star_ids[i] - 1][1];
                    next_data[1][i] = sm_GC[next_star_ids[i] - 1][2];
                    next_data[2][i] = sm_GC[next_star_ids[i] - 1][3];
                }
                next_matched_stars = RBM_matched_stars;
                TM_on = true;
                // printf("GO TO ESTIMAION\n");
            }

            else
            {
                int new_matched_stars = 0;
                double newEntries[N_TH_TRACKING][4];

                starNeighbourhoodMatch(RBM_centroid_st, RBM_matched_stars, UIS_frames[next_frame], next_tot_stars, sm_SNT, sm_GC, newEntries, &new_matched_stars);
                
                // printf("newMatched_stars: %d\n", new_matched_stars);
                next_matched_stars = RBM_matched_stars + new_matched_stars;

                for (int i = RBM_matched_stars; i < next_matched_stars; i++)
                {
                    next_input_ids[i] = newEntries[i - RBM_matched_stars][0];
                    next_star_ids[i] = newEntries[i - RBM_matched_stars][1];
                    // printf("%d ", next_star_ids[i]);
                }

                for (int i = 0; i < MAX_STARS; i++)
                {
                    next_data[0][i] = sm_GC[next_star_ids[i] - 1][1];
                    next_data[1][i] = sm_GC[next_star_ids[i] - 1][2];
                    next_data[2][i] = sm_GC[next_star_ids[i] - 1][3];
                }
                // printf("Identify new stars entering the FOV\n");

                if (next_matched_stars < N_TH_SNT) TM_on = false;
                else TM_on = true;
            }
        }
        else{
            TM_on = false;
            continue;
        }
    }
    end = clock();
    double duration = ((double)end - start)/CLOCKS_PER_SEC;
    printf("Time taken to execute in seconds : %f", duration);
}
